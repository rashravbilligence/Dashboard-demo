<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collibra Connection</title>
</head>
<body>

    <h2>Collibra API Connection</h2>
    <button onclick="connectToCollibra()">Connect to Collibra</button>
    <p id="status">Click the button to authenticate and fetch data.</p>

    <script>
        async function connectToCollibra() {
            const authUrl = "https://billigence-demo.collibra.com/rest/2.0/auth/sessions";
            const dataUrl = "https://billigence-demo.collibra.com/rest/2.0/outputModule/export/json?validationEnabled=false";
            const username = "rashrav.shrestha";  
            const password = "R@sh$1234";  

            try {
                document.getElementById("status").textContent = "Authenticating...";

                // Step 1: Authenticate
                const authResponse = await fetch(authUrl, {
                    method: "POST",
                    headers: {
                        "Accept": "application/json",
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ username, password }),
                    credentials: "include"
                });

                if (!authResponse.ok) {
                    throw new Error(`Authentication failed: ${authResponse.status}`);
                }

                const authData = await authResponse.json();
                const csrfToken = authData.csrfToken;
                console.log("✅ Authentication Successful! CSRF Token:", csrfToken);
                document.getElementById("status").textContent = "✅ Authenticated! Fetching data...";

                // Step 2: Fetch Data from Collibra
                const dataResponse = await fetch(dataUrl, {
                    method: "POST",
                    headers: {
                        "Accept": "application/json",
                        "X-CSRF-TOKEN": csrfToken,
                        "Content-Type": "application/json"
                    },
                    credentials: "include",
                    body: JSON.stringify({
                        "TableViewConfig": { 
                            "displayLength": 5, 
                            "Resources": { "Asset": { "Name": { "name": "asset name" } } } 
                        } 
                    })
                });

                if (!dataResponse.ok) {
                    throw new Error(`Data fetch failed: ${dataResponse.status}`);
                }

                const data = await dataResponse.json();
                console.log("✅ Data Fetched Successfully:", data);
                document.getElementById("status").textContent = "✅ Data Fetched! Check console for details.";

            } catch (error) {
                console.error("❌ Error:", error);
                document.getElementById("status").textContent = `❌ Error: ${error.message}`;
            }
        }
    </script>

</body>
</html>
